{% extends "base.html" %}

{% block title %}Actividades - Rutas Gastronómicas{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-utensils me-2"></i>Actividades Gastronómicas</h2>
            <hr>
        </div>
    </div>
    
    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5>Filtrar por Ubicación</h5>
                    <select class="form-select" id="cityFilter">
                        <option value="">Todas las ciudades</option>
                        <option value="Querétaro">Querétaro</option>
                        <option value="Tequisquiapan">Tequisquiapan</option>
                        <option value="Bernal">Bernal</option>
                        <option value="San Juan del Río">San Juan del Río</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5>Ordenar por</h5>
                    <select class="form-select" id="sortFilter">
                        <option value="name">Nombre</option>
                        <option value="cost">Precio</option>
                        <option value="duration">Duración</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Lista de Actividades -->
    <div class="row" id="activitiesContainer">
        {% for activity in activities %}
        <div class="col-md-6 col-lg-4 mb-4 activity-card" data-city="{{ activity.city }}" data-cost="{{ activity.cost }}">
            <div class="card h-100 shadow-sm">
                <img src="{{ activity.image_url or '/static/images/default-activity.jpg' }}" 
                     class="card-img-top" alt="{{ activity.name }}" style="height: 250px; object-fit: cover;">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">{{ activity.name }}</h5>
                    <p class="card-text">{{ activity.description }}</p>
                    
                    <div class="mt-auto">
                        <div class="row mb-2">
                            <div class="col-6">
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>{{ activity.duration }}
                                </small>
                            </div>
                            <div class="col-6 text-end">
                                <span class="fw-bold text-success">${{ activity.cost }}</span>
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="fas fa-map-marker-alt me-1"></i>{{ activity.location }}, {{ activity.city }}
                            </small>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="showActivityDetails('{{ activity.id }}')">
                                <i class="fas fa-info-circle me-1"></i>Ver Detalles
                            </button>
                            <button class="btn btn-success" onclick="bookActivity('{{ activity.id }}')">
                                <i class="fas fa-calendar-plus me-1"></i>Reservar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal para detalles de actividad -->
<div class="modal fade" id="activityModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Detalles de la Actividad</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Contenido cargado dinámicamente -->
            </div>
        </div>
    </div>
</div>

<!-- Modal para reservar -->
<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reservar Actividad</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bookingForm">
                    <input type="hidden" id="activityId">
                    <div class="mb-3">
                        <label for="appointmentDate" class="form-label">Fecha y Hora</label>
                        <input type="datetime-local" class="form-control" id="appointmentDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notas (Opcional)</label>
                        <textarea class="form-control" id="notes" rows="3" 
                                  placeholder="Número de personas, preferencias especiales, etc."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="confirmBooking()">Confirmar Reserva</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Filtros
document.getElementById('cityFilter').addEventListener('change', filterActivities);
document.getElementById('sortFilter').addEventListener('change', sortActivities);

function filterActivities() {
    const cityFilter = document.getElementById('cityFilter').value;
    const activities = document.querySelectorAll('.activity-card');
    
    activities.forEach(activity => {
        const activityCity = activity.dataset.city;
        if (cityFilter === '' || activityCity === cityFilter) {
            activity.style.display = 'block';
        } else {
            activity.style.display = 'none';
        }
    });
}

function sortActivities() {
    const sortBy = document.getElementById('sortFilter').value;
    const container = document.getElementById('activitiesContainer');
    const activities = Array.from(container.children);
    
    activities.sort((a, b) => {
        if (sortBy === 'cost') {
            return parseFloat(a.dataset.cost) - parseFloat(b.dataset.cost);
        } else if (sortBy === 'name') {
            return a.querySelector('.card-title').textContent.localeCompare(
                b.querySelector('.card-title').textContent
            );
        }
        return 0;
    });
    
    activities.forEach(activity => container.appendChild(activity));
}

async function showActivityDetails(activityId) {
    try {
        const response = await fetch(`/activities/${activityId}`);
        const activity = await response.json();
        
        document.getElementById('modalTitle').textContent = activity.name;
        document.getElementById('modalBody').innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <img src="${activity.image_url || '/static/images/default-activity.jpg'}" 
                         class="img-fluid rounded" alt="${activity.name}">
                </div>
                <div class="col-md-6">
                    <h5>Descripción</h5>
                    <p>${activity.description}</p>
                    
                    <h6>Detalles</h6>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-clock me-2"></i><strong>Duración:</strong> ${activity.duration}</li>
                        <li><i class="fas fa-dollar-sign me-2"></i><strong>Precio:</strong> ${activity.cost}</li>
                        <li><i class="fas fa-map-marker-alt me-2"></i><strong>Ubicación:</strong> ${activity.location}, ${activity.city}</li>
                    </ul>
                </div>
            </div>
        `;
        
        new bootstrap.Modal(document.getElementById('activityModal')).show();
    } catch (error) {
        alert('Error al cargar los detalles');
    }
}

function bookActivity(activityId) {
    const userId = localStorage.getItem('user_id');
    if (!userId) {
        alert('Debes iniciar sesión para hacer una reserva');
        window.location.href = '/users/auth/login';
        return;
    }
    
    document.getElementById('activityId').value = activityId;
    
    // Establecer fecha mínima como mañana
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('appointmentDate').min = tomorrow.toISOString().slice(0, 16);
    
    new bootstrap.Modal(document.getElementById('bookingModal')).show();
}

async function confirmBooking() {
    const userId = localStorage.getItem('user_id');
    const activityId = document.getElementById('activityId').value;
    const appointmentDate = document.getElementById('appointmentDate').value;
    const notes = document.getElementById('notes').value;
    
    if (!appointmentDate) {
        alert('Por favor selecciona una fecha y hora');
        return;
    }
    
    try {
        const response = await fetch(`/appointments/?user_id=${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                activity_id: parseInt(activityId),
                appointment_date: appointmentDate + ':00',
                notes: notes
            })
        });
        
        if (response.ok) {
            alert('Reserva confirmada exitosamente');
            bootstrap.Modal.getInstance(document.getElementById('bookingModal')).hide();
            // Limpiar formulario
            document.getElementById('bookingForm').reset();
        } else {
            const error = await response.json();
            alert('Error al crear la reserva: ' + error.detail);
        }
    } catch (error) {
        alert('Error de conexión');
    }
}
</script>
{% endblock %}